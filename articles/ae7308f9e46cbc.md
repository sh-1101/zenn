---
title: "NestJSã§ã®Google OAuthå®Ÿè£…ã§ã€stateãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚‹æ–¹æ³•"
emoji: "ğŸ“–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["typescript", "nestjs", "oauth", "zennfes2025free"]
published: true
---

NestJS ã§ Google OAuth ã‚’å®Ÿè£…ã™ã‚‹éš›ã€èªè¨¼ãƒ•ãƒ­ãƒ¼ã®ä¸€ç’°ã¨ã—ã¦ redirect URI ã« state ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¸¡ã—ãŸã‹ã£ãŸã®ã§ã™ãŒã€ã†ã¾ãæ¸¡ã›ãšå›°ã£ãŸãŸã‚ã€è§£æ±ºæ–¹æ³•ã‚’å…±æœ‰ã—ã¾ã™ã€‚

state ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ CSRF æ”»æ’ƒã‚’é˜²æ­¢ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã€èªè¨¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’é–¢é€£ä»˜ã‘ã‚‹å½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚ï¼ˆã‚¢ãƒ—ãƒªå´ã®ä»»æ„ã®æƒ…å ±ã‚’ä¿æŒã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã¾ã™ã€‚ï¼‰

## ç’°å¢ƒ

- Node.js: v22.16.0
- passport: v0.7.0
- passport-google-oauth20: v2.0.0
- passport-jwt: v4.0.1

## ç™ºç”Ÿã—ãŸç¾è±¡

ä»¥ä¸‹ã®ã‚ˆã†ã«ã€Google OAuth ã®èªè¨¼ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã« state ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä»˜ä¸ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸãŒã€ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ state ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒ `undefined` ã¨ãªã‚Šã€æ­£å¸¸ã«å—ã‘å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚

```typescript

  //ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰ã“ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹
  @Get('/google')
  @UseGuards(AuthGuard('google'))
  async googleAuth(@Req() _req: any): Promise<void> {}

  // Googleã‹ã‚‰ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’å—ã‘å–ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
  @Get('/google/redirect')
  @UseGuards(GoogleOauthGuard)
  async googleAuthRedirect(
    @Req() req: any,
    @Res({ passthrough: true }) res: Response,
  ): Promise<void> {

  console.log('state:', req.query.state); // ã“ã“ã§ state ãŒ undefined ã«ãªã£ã¦ã„ãŸ

    //çœç•¥
  }

```

## è§£æ±ºæ–¹æ³•

### ã‚«ã‚¹ã‚¿ãƒ ã‚¬ãƒ¼ãƒ‰ã®ä½œæˆ

NestJS æ¨™æº–ã®`AuthGuard('google')`ãŒ Google ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆæ™‚ã« ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ¯ã«ç•°ãªã‚‹ state ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®šã§ããªã‹ã£ãŸãŸã‚ã€
AuthGuard('google') ã‚’æ‹¡å¼µã—ã€state ã‚’æ˜ç¤ºçš„ã« Google ã«æ¸¡ã™ã‚«ã‚¹ã‚¿ãƒ ã‚¬ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ state ã‚’å‹•çš„ã«å–å¾—ã—ã¦æ¸¡ã™ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

```typescript
//NOTE: ã“ã®ã‚³ãƒ¼ãƒ‰ä¾‹ã¯AIç”Ÿæˆã§ã™

// google-auth.guard.ts
import { Injectable } from "@nestjs/common";
import { AuthGuard } from "@nestjs/passport";

@Injectable()
export class GoogleAuthGuard extends AuthGuard("google") {
  getAuthenticateOptions(context) {
    const request = context.switchToHttp().getRequest();
    const state = request.query.state;
    return {
      scope: ["email", "profile", "openid"],
      accessType: "offline",
      state, // â† ã“ã“ã§Googleã¸æ˜ç¤ºçš„ã«æ¸¡ã™
    };
  }
}

// auth.controller.tsã§ä¸Šè¨˜Guardã‚’ä½¿ç”¨
@Get('/google/redirect')
@UseGuards(GoogleAuthGuard)
async googleAuthRedirect(
  @Req() req: any,
  @Res({ passthrough: true }) res: Response,
): Promise<void> {
  // req.user ã« GoogleUser ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå…¥ã£ã¦ãŠã‚Šã€
  // ãã®ä¸­ã« state ãŒå«ã¾ã‚Œã¦ã„ã‚‹
  console.log('state:', req.user.state);

  // ä»¥é™ã®å‡¦ç†
}
```

### GoogleStrategy ã®è¨­å®šå¤‰æ›´

ã¾ãŸã€AuthGuard('google')ãŒå‘¼ã³å‡ºã™ GoogleStrategy ã®`validate`ãƒ¡ã‚½ãƒƒãƒ‰ã§ state ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

å…ƒã€… GoogleStrategy ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§`passReqToCallback`ã‚’è¨­å®šã—ã¦ã„ãªã‹ã£ãŸãŸã‚ HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å—ã‘å–ã‚Œã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚
`passReqToCallback: true`ã‚’è¨­å®šã—ãŸã“ã¨ã§`validate`ãƒ¡ã‚½ãƒƒãƒ‰ã®ç¬¬ä¸€å¼•æ•°ã« HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæ¸¡ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸãŸã‚ã€ãã“ã‹ã‚‰ state ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

```typescript
// google.strategy.ts
@Injectable()
export class GoogleStrategy extends PassportStrategy(Strategy, "google") {
  constructor(private readonly configService: ConfigService) {
    super({
      // ... ä»–ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
      passReqToCallback: true, // trueã«è¨­å®šã™ã‚‹ã¨validateãƒ¡ã‚½ãƒƒãƒ‰ã®ç¬¬ä¸€å¼•æ•°ã«HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¸¡ã™
    });
  }

  async validate(
    req: any,
    accessToken: string,
    refreshToken: string,
    profile: Profile,
    _done: VerifyCallback
  ): Promise<GoogleUser> {
    const state = req.query.state; // â† ã“ã“ã§ state ã‚’å–å¾—

    const user: GoogleUser = {
      id: GoogleId(id),
      email: GoogleEmail(emails[0].value),
      // ... ä»–ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
      state: state || null, // â† state ã‚’å«ã‚ã‚‹
    };

    return user;
  }
}
```

ä»¥ä¸Šã®å¯¾å¿œã«ã‚ˆã‚Šã€Google OAuth ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆæ™‚ã« state ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ­£å¸¸ã«å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

## ã¾ã¨ã‚

NestJS ã§ Google OAuth ã‚’å®Ÿè£…ã™ã‚‹éš›ã€state ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ­£ã—ãæ¸¡ã™ãŸã‚ã«ã¯ã€AuthGuard ã‚’æ‹¡å¼µã—ã¦ state ã‚’æ˜ç¤ºçš„ã«æ¸¡ã—ã€GoogleStrategy ã® validate ãƒ¡ã‚½ãƒƒãƒ‰ã§ HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å—ã‘å–ã‚‹è¨­å®šã‚’ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚
åŒã˜ç¾è±¡ã§æ‚©ã‚“ã§ã„ã‚‹æ–¹ã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚
ä½•ã‹é–“é•ã„ã‚„ãŠæ°—ã¥ãã®ç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ã‚³ãƒ¡ãƒ³ãƒˆã„ãŸã ã‘ã‚Œã°ã¨æ€ã„ã¾ã™ã€‚
